
<style>
    body{
        background-color: #382851;
    }
    #container{
        height:95vh;
    }
</style>
</style>
<script src="https://code.highcharts.com/maps/highmaps.js"></script>
<script src="purple-theme.js"></script>
<div id="container"></div>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const state = urlParams.get('state')
    const school = urlParams.get('school')
    const category = urlParams.get('category');
    const year = urlParams.get('year');
    // console.log(name)
    (async () => {

        function crypt(s) {
            if (s.length > 13) {
                return s.charCodeAt(15) + s.slice(-1).charCodeAt(0);
            } else {
                return s.length;
            }
        }

        schools={
            'All Schools':0,
            'PS (I-V)':1,
            'UPS (I-VIII)':2,
            'HSS (I-XII)':3,
            'UPS (VI-VIII)':4,
            'HSS (VI-XII)':5,
            'SS (I-X)':6,
            'SS (VI-X)':7,
            'SS (IX-X)':8,
            'HSS (IX-XII)':9,
            'HSS (XI-XII)':10,
        }
        totalData=[]

        mainData = await fetch(
            `https://chartify.in/api/udise/choropleth/${crypt(category)}/${state}/${year}`
        ).then(response => response.json());
        if (category!="Total Schools")
            totalData = await fetch(
                `https://chartify.in/api/udise/choropleth/${crypt('Total Schools')}/${state}/${year}`
            ).then(response => response.json());


        let data=[]
        console.log(mainData)

        for (i in mainData)
            if (i!='India' && i!=''){
                if (category!="Total Schools")
                    data.push([i,Math.round(10000*mainData[i][schools[school]]/totalData[i][schools[school]])/100])
                else
                    data.push([i,mainData[i][schools[school]]])
            }


        console.log(data)

        function getMap(){
            if (state === "India") 
                if (parseInt(year) < 2000) 
                    mapURL = "https://besnoi.github.io/maps/json/india-1999.json";
                else if (parseInt(year)<2014) 
                    mapURL = "https://besnoi.github.io/maps/json/india-2013.json";
                else if (parseInt(year)<2019) 
                    mapURL = "https://besnoi.github.io/maps/json/india2018.json";
                else
                    mapURL = "https://besnoi.github.io/maps/json/india-2019.json"

            else 
                if (state === "Andhra Pradesh" && Number.parseInt(year) < 2014) 
                    mapURL = "https://besnoi.github.io/maps/json/andhra-pradesh-2014.json";
                else 
                    mapURL = "https://besnoi.github.io/maps/json/" + state.toLowerCase() + ".json";
                
            
            if (parseInt(year) < 2001 && ["Bihar", "Madhya Pradesh", "Uttar Pradesh"].includes(state)) 
                mapURL = `https://besnoi.github.io/maps/json/${state.toLowerCase()}-1999.json`;
            else 
                if (Number.parseInt(year) < 2011 && ["Bihar", "Madhya Pradesh", "Uttar Pradesh"].includes(state))
                    mapURL = `https://besnoi.github.io/maps/json/${state.toLowerCase()}-2001.json`;
                else 
                    if (Number.parseInt(year) < 2021 &&  ["Uttar Pradesh"].includes(state)) 
                        mapURL = `https://besnoi.github.io/maps/json/${state.toLowerCase()}-2011.json`;
            if (state=='Jammu and Kashmir' && parseInt(year)>=2019)
                mapURL='https://besnoi.github.io/maps/json/jammu and kashmir-2019.json'
            return mapURL
        
            }
                

        const topology = await fetch(getMap()).then(response => response.json());

        mapChart = Highcharts.mapChart('container', {
            chart: {
                animation: true,
                map: topology
            },

            title: {
                text: category.replaceAll('-',' ')+' ('+school+')'+', '+state,
                align:'center'
            },

            credits:{
                enabled:false
            },

            subtitle: {
                text: 'Source: UDISE-PLUS'
            },

            mapNavigation: {
                enabled: true,
                buttonOptions: {
                    verticalAlign: 'bottom'
                }
            },

            colorAxis: {
                minColor: "#FDFD96",
                maxColor: "#00c853"
            },
            
            series: [{
                name: category!="Total Schools" && 'Percentage' || 'Number',
                states: {
                    hover: {
                        color: '#BADA55'
                    }
                },
                dataLabels: {
                    enabled: false,
                    format: '{point.name}'
                }
            }]
        });
        mapChart.update({
            series:{data:data}
        })
    })()

</script>
